<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="referrer" content="no-referrer" />
<title>Bird Quiz (Proxied Images)</title>
<style>
  :root { --bg:#f7f7f8; --panel:#fff; --border:#e5e7eb; --text:#111827; --accent:#2563eb; --warn:#b91c1c; --ok:#065f46; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); display:flex; min-height:100vh; }
  #sidebar { width:280px; background:var(--panel); border-right:1px solid var(--border); padding:20px; }
  #main { flex:1; padding:24px; display:flex; flex-direction:column; align-items:center; gap:16px; }
  h1 { font-size:20px; margin:0 0 8px; }
  .muted { color:#6b7280; font-size:12px; margin:0 0 16px; }
  fieldset { border:0; padding:0; margin:0 0 12px; }
  label { display:block; margin:6px 0; font-size:14px; }
  button { appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:10px 14px; border-radius:8px; cursor:pointer; transition:.15s ease; font-weight:600; }
  button:hover { border-color:#cbd5e1; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  img { max-width:560px; max-height:380px; width:100%; object-fit:contain; border:1px solid var(--border); background:#fff; border-radius:10px; display:none; }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .answer { font-style:italic; min-height:20px; }
  .hint { font-size:12px; color:#6b7280; }
  #status { font-size:12px; color:#6b7280; min-height:18px; }
  .ok { color:var(--ok); }
  .bad { color:var(--warn); }
  .toggle { display:flex; align-items:center; gap:8px; margin-top:8px; font-size:13px; }
</style>
</head>
<body>
  <aside id="sidebar">
    <h2 style="margin:0 0 8px; font-size:18px;">Filter by location</h2>
    <p class="muted">(Optional – narrows the pool)</p>
    <fieldset id="filters">
      <label><input type="radio" name="location" value="all" checked> All</label>
      <label><input type="radio" name="location" value="us"> United States</label>
      <label><input type="radio" name="location" value="midwest"> US Midwest</label>
      <label><input type="radio" name="location" value="east"> US East Coast</label>
      <label><input type="radio" name="location" value="west"> US West Coast</label>
      <label><input type="radio" name="location" value="south"> US South</label>
      <label><input type="radio" name="location" value="canada"> Canada</label>
      <label><input type="radio" name="location" value="europe"> Europe</label>
    </fieldset>
    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">
    <div class="toggle">
      <input type="checkbox" id="forceProxy">
      <label for="forceProxy">Force image proxy (use if images are blocked)</label>
    </div>
    <button id="selfTestBtn" title="Quick check that images load from your site" style="margin-top:10px;">Run image self‑test</button>
    <p id="selfTestResult" class="hint" style="margin-top:8px;"></p>
  </aside>

  <main id="main">
    <h1>Bird Quiz</h1>
    <p class="muted">No external APIs. Multiple sources + optional proxy. Guaranteed fallback image if everything is blocked.</p>
    <div class="row">
      <button id="quizBtn" class="primary">Quiz me on a bird</button>
      <button id="knowBtn" disabled>I know it</button>
      <button id="dontKnowBtn" disabled>I don’t know it</button>
    </div>
    <div id="status"></div>
    <img id="birdImage" alt="Random bird" referrerpolicy="no-referrer" crossorigin="anonymous">
    <div id="birdName" class="answer"></div>
    <p class="hint">If your network/extension blocks Wikimedia, toggle “Force image proxy.”</p>
  </main>

<script>
// Inline fallback: always available
const INLINE_FALLBACK = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='560' height='380' viewBox='0 0 560 380'%3E%3Crect width='100%25' height='100%25' fill='%23ffffff'/%3E%3Ctext x='50%25' y='20%25' dominant-baseline='middle' text-anchor='middle' fill='%239aa1ab' font-family='Arial' font-size='16'%3EBird image fallback%3C/text%3E%3Cpath d='M120 250c60-80 140-80 200-60 30 10 60 10 100-10-30 40-60 60-90 70 10 10 40 30 70 40-60-10-110-40-150-60-20 30-60 50-130 20z' fill='%2390caf9'/%3E%3C/svg%3E";

// Helper: proxy a URL via images.weserv.nl (common static image proxy)
function viaProxy(url){
  try{
    const u = new URL(url);
    const hostAndPath = u.host + u.pathname + (u.search||'');
    return `https://images.weserv.nl/?url=${encodeURIComponent(hostAndPath)}`;
  }catch{ return url; }
}

const CANDIDATES = {
  "American Robin": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/American_Robin.jpg/640px-American_Robin.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/56/American_Robin.jpg",
    // Special:FilePath can also serve the raw file
    "https://commons.wikimedia.org/wiki/Special:FilePath/American_Robin.jpg?width=640"
  ],
  "Northern Cardinal": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Northern_Cardinal_male.jpg/640px-Northern_Cardinal_male.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/8/84/Northern_Cardinal_male.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/Northern_Cardinal_male.jpg?width=640"
  ],
  "Blue Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Blue_Jay.jpg/640px-Blue_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/8/80/Blue_Jay.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/Blue_Jay.jpg?width=640"
  ],
  "Mallard": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Mallard_drake.jpg/640px-Mallard_drake.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/51/Mallard_drake.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/Mallard_drake.jpg?width=640"
  ],
  "European Goldfinch": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/European_Goldfinch.jpg/640px-European_Goldfinch.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/b/b4/European_Goldfinch.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/European_Goldfinch.jpg?width=640"
  ],
  "California Scrub Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/California_Scrub_Jay.jpg/640px-California_Scrub_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/4/47/California_Scrub_Jay.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/California_Scrub_Jay.jpg?width=640"
  ],
  "Northern Mockingbird": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Northern_Mockingbird.jpg/640px-Northern_Mockingbird.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/5d/Northern_Mockingbird.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/Northern_Mockingbird.jpg?width=640"
  ],
  "Gray Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Gray_Jay.jpg/640px-Gray_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/3/35/Gray_Jay.jpg",
    "https://commons.wikimedia.org/wiki/Special:FilePath/Gray_Jay.jpg?width=640"
  ]
};

const SETS = {
  all: ["American Robin","Northern Cardinal","Blue Jay","Mallard","European Goldfinch","California Scrub Jay","Northern Mockingbird","Gray Jay"],
  us: ["American Robin","Northern Cardinal","Blue Jay","Northern Mockingbird"],
  midwest: ["American Robin"],
  east: ["Blue Jay"],
  west: ["California Scrub Jay"],
  south: ["Northern Mockingbird"],
  canada: ["Gray Jay"],
  europe: ["European Goldfinch"]
};

let current = null;
let loadToken = 0; // cancels older attempts
const img = document.getElementById('birdImage');
const nameBox = document.getElementById('birdName');
const statusBox = document.getElementById('status');
const quizBtn = document.getElementById('quizBtn');
const knowBtn = document.getElementById('knowBtn');
const dontBtn = document.getElementById('dontKnowBtn');
const forceProxy = document.getElementById('forceProxy');

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function setStatus(s){ statusBox.textContent = s||''; }

function showBird(){
  const location = document.querySelector('input[name="location"]:checked').value;
  const pool = SETS[location] || SETS.all;
  const name = pick(pool);
  current = { name };
  nameBox.textContent = '';
  knowBtn.disabled = false; dontBtn.disabled = false;
  img.style.display = 'block';

  const myToken = ++loadToken;
  const baseList = CANDIDATES[name] || [];
  // Build try-list: originals + (if needed) proxies
  const tryList = forceProxy.checked ? baseList.map(viaProxy) : baseList.concat(baseList.map(viaProxy));
  let i = 0;

  function next(){
    if (myToken !== loadToken) return; // canceled by newer click
    if (i >= tryList.length){
      img.onerror = img.onload = null;
      img.src = INLINE_FALLBACK;
      img.alt = `${name} (fallback)`;
      setStatus('All sources blocked; showing built‑in fallback. Try enabling "Force image proxy".');
      return;
    }
    const url = tryList[i++];
    setStatus(`Loading ${name}… (${i}/${tryList.length})`);
    img.onerror = () => { if (myToken === loadToken) next(); };
    img.onload = () => { if (myToken === loadToken) setStatus(''); };
    img.referrerPolicy = 'no-referrer';
    img.crossOrigin = 'anonymous';
    img.src = url + (url.includes('?')?'&':'?') + 'cb=' + Date.now();
    img.alt = name;
  }
  next();
}

quizBtn.addEventListener('click', showBird);
knowBtn.addEventListener('click', showBird);
dontBtn.addEventListener('click', () => { if(current) nameBox.textContent = `It’s a ${current.name}.`; });

// Self-test: probe first URL of each bird (without blocking UI)
async function selfTest(){
  const r = document.getElementById('selfTestResult');
  r.textContent = 'Testing…';
  let ok=0, fail=0;
  for (const name of Object.keys(CANDIDATES)){
    const url = (forceProxy.checked ? viaProxy(CANDIDATES[name][0]) : CANDIDATES[name][0]) + '?probe=' + Date.now();
    await new Promise(res => {
      const t = new Image();
      t.referrerPolicy = 'no-referrer';
      t.crossOrigin = 'anonymous';
      const done = (good) => { ok += good?1:0; fail += good?0:1; t.onload=t.onerror=null; res(); };
      t.onload = () => done(true);
      t.onerror = () => done(false);
      t.src = url;
    });
  }
  r.innerHTML = `<span class="ok">Loaded: ${ok}</span> • <span class="bad">Failed: ${fail}</span>. ${fail? 'Toggle "Force image proxy" if many failed.' : 'Looks good!'}`;
}

document.getElementById('selfTestBtn').addEventListener('click', selfTest);
</script>
</body>
</html>
