<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="referrer" content="no-referrer" />
<title>Bird Quiz (Safe + Diagnostics)</title>
<style>
  :root { --bg:#f7f7f8; --panel:#fff; --border:#e5e7eb; --text:#111827; --accent:#2563eb; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--text); background:var(--bg); display:flex; min-height:100vh; }
  #sidebar { width:260px; background:var(--panel); border-right:1px solid var(--border); padding:20px; }
  #main { flex:1; padding:24px; display:flex; flex-direction:column; align-items:center; gap:16px; }
  h1 { font-size:20px; margin:0 0 8px; }
  .muted { color:#6b7280; font-size:12px; margin:0 0 16px; }
  fieldset { border:0; padding:0; margin:0 0 12px; }
  label { display:block; margin:6px 0; font-size:14px; }
  button { appearance:none; border:1px solid var(--border); background:var(--panel); color:var(--text); padding:10px 14px; border-radius:8px; cursor:pointer; transition:.15s ease; font-weight:600; }
  button:hover { border-color:#cbd5e1; box-shadow:0 1px 0 rgba(0,0,0,.03); }
  button.primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  img { max-width:560px; max-height:380px; width:100%; object-fit:contain; border:1px solid var(--border); background:#fff; border-radius:10px; display:none; }
  .row { display:flex; gap:8px; flex-wrap:wrap; }
  .answer { font-style:italic; min-height:20px; }
  .hint { font-size:12px; color:#6b7280; }
  #status { font-size:12px; color:#6b7280; min-height:18px; }
  .ok { color:#065f46; }
  .bad { color:#b91c1c; }
</style>
</head>
<body>
  <aside id="sidebar">
    <h2 style="margin:0 0 8px; font-size:18px;">Filter by location</h2>
    <p class="muted">(Optional – narrows the pool)</p>
    <fieldset id="filters">
      <label><input type="radio" name="location" value="all" checked> All</label>
      <label><input type="radio" name="location" value="us"> United States</label>
      <label><input type="radio" name="location" value="midwest"> US Midwest</label>
      <label><input type="radio" name="location" value="east"> US East Coast</label>
      <label><input type="radio" name="location" value="west"> US West Coast</label>
      <label><input type="radio" name="location" value="south"> US South</label>
      <label><input type="radio" name="location" value="canada"> Canada</label>
      <label><input type="radio" name="location" value="europe"> Europe</label>
    </fieldset>
    <hr style="border:none;border-top:1px solid var(--border);margin:14px 0;">
    <button id="selfTestBtn" title="Quick check that images load from your site">Run image self‑test</button>
    <p id="selfTestResult" class="hint" style="margin-top:8px;"></p>
  </aside>

  <main id="main">
    <h1>Bird Quiz</h1>
    <p class="muted">No external APIs; finite list; retry with multiple sources; guaranteed fallback image. No infinite loops.</p>
    <div class="row">
      <button id="quizBtn" class="primary">Quiz me on a bird</button>
      <button id="knowBtn" disabled>I know it</button>
      <button id="dontKnowBtn" disabled>I don’t know it</button>
      <button id="stopBtn" title="Cancel any in-flight load" disabled>Stop</button>
    </div>
    <div id="status"></div>
    <img id="birdImage" alt="Random bird" referrerpolicy="no-referrer" crossorigin="anonymous">
    <div id="birdName" class="answer"></div>
    <p class="hint">If an image can’t load, this app automatically retries other sources and finally shows a built‑in fallback so you never get stuck.</p>
  </main>

<script>
// --- Built‑in fallback (always works): inline SVG placeholder
const INLINE_FALLBACK = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='560' height='380' viewBox='0 0 560 380'%3E%3Crect width='100%25' height='100%25' fill='%23ffffff'/%3E%3Ctext x='50%25' y='20%25' dominant-baseline='middle' text-anchor='middle' fill='%239aa1ab' font-family='Arial' font-size='16'%3EBird image fallback%3C/text%3E%3Cpath d='M120 250c60-80 140-80 200-60 30 10 60 10 100-10-30 40-60 60-90 70 10 10 40 30 70 40-60-10-110-40-150-60-20 30-60 50-130 20z' fill='%2390caf9'/%3E%3C/svg%3E";

// Data: multiple CDN candidates per bird (first that loads wins). Finite list = no infinite fetch.
const CANDIDATES = {
  "American Robin": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/56/American_Robin.jpg/640px-American_Robin.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/56/American_Robin.jpg"
  ],
  "Northern Cardinal": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/8/84/Northern_Cardinal_male.jpg/640px-Northern_Cardinal_male.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/8/84/Northern_Cardinal_male.jpg"
  ],
  "Blue Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Blue_Jay.jpg/640px-Blue_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/8/80/Blue_Jay.jpg"
  ],
  "Mallard": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Mallard_drake.jpg/640px-Mallard_drake.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/51/Mallard_drake.jpg"
  ],
  "European Goldfinch": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/b/b4/European_Goldfinch.jpg/640px-European_Goldfinch.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/b/b4/European_Goldfinch.jpg"
  ],
  "California Scrub Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/4/47/California_Scrub_Jay.jpg/640px-California_Scrub_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/4/47/California_Scrub_Jay.jpg"
  ],
  "Northern Mockingbird": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/5/5d/Northern_Mockingbird.jpg/640px-Northern_Mockingbird.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/5/5d/Northern_Mockingbird.jpg"
  ],
  "Gray Jay": [
    "https://upload.wikimedia.org/wikipedia/commons/thumb/3/35/Gray_Jay.jpg/640px-Gray_Jay.jpg",
    "https://upload.wikimedia.org/wikipedia/commons/3/35/Gray_Jay.jpg"
  ]
};

const SETS = {
  all: ["American Robin","Northern Cardinal","Blue Jay","Mallard","European Goldfinch","California Scrub Jay","Northern Mockingbird","Gray Jay"],
  us: ["American Robin","Northern Cardinal","Blue Jay","Northern Mockingbird"],
  midwest: ["American Robin"],
  east: ["Blue Jay"],
  west: ["California Scrub Jay"],
  south: ["Northern Mockingbird"],
  canada: ["Gray Jay"],
  europe: ["European Goldfinch"]
};

let current = null;
let loadToken = 0; // increments on every new request; cancels previous attempts
const img = document.getElementById('birdImage');
const nameBox = document.getElementById('birdName');
const statusBox = document.getElementById('status');
const quizBtn = document.getElementById('quizBtn');
const knowBtn = document.getElementById('knowBtn');
const dontBtn = document.getElementById('dontKnowBtn');
const stopBtn = document.getElementById('stopBtn');

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function setStatus(text){ statusBox.textContent = text || ''; }

function stopLoading(){
  loadToken++; // invalidate any in-flight tries
  setStatus('');
  stopBtn.disabled = true;
}

function showBird(){
  const location = document.querySelector('input[name="location"]:checked').value;
  const pool = SETS[location] || SETS.all;
  const birdName = pick(pool);
  current = { name: birdName };
  nameBox.textContent = '';
  knowBtn.disabled = false; dontBtn.disabled = false; stopBtn.disabled = false;
  img.style.display = 'block';
  const myToken = ++loadToken; // unique to this request
  const list = (CANDIDATES[birdName] || []).slice();
  let i = 0;

  function tryNext(){
    if (myToken !== loadToken) return; // canceled by a newer request
    if (i >= list.length){
      img.onerror = img.onload = null;
      img.src = INLINE_FALLBACK;
      img.alt = `${birdName} (fallback)`;
      setStatus('Showing built‑in fallback image.');
      stopBtn.disabled = true;
      return;
    }
    const url = list[i++];
    setStatus(`Loading ${birdName}… (source ${i}/${list.length})`);
    img.onerror = () => { if (myToken === loadToken) tryNext(); };
    img.onload = () => { if (myToken === loadToken){ setStatus(''); stopBtn.disabled = true; } };
    img.referrerPolicy = 'no-referrer';
    img.crossOrigin = 'anonymous';
    img.src = url + (url.includes('?')?'&':'?') + 'cb=' + Date.now(); // cachebust
    img.alt = birdName;
  }
  tryNext();
}

quizBtn.addEventListener('click', showBird);
knowBtn.addEventListener('click', showBird);
dontBtn.addEventListener('click', () => { if(current) nameBox.textContent = `It’s a ${current.name}.`; });
stopBtn.addEventListener('click', stopLoading);

// Self‑test: probe one URL from each bird and report which load
async function selfTest(){
  const result = document.getElementById('selfTestResult');
  result.textContent = 'Testing…';
  const birds = Object.keys(CANDIDATES);
  let ok=0, fail=0;
  for(const b of birds){
    const testUrl = CANDIDATES[b][0];
    await new Promise((done)=>{
      const t = Symbol('t');
      const img2 = new Image();
      img2.referrerPolicy = 'no-referrer';
      img2.crossOrigin = 'anonymous';
      const clear = () => { img2.onload = img2.onerror = null; done(); };
      img2.onload = clear; img2.onerror = clear;
      img2.src = testUrl + (testUrl.includes('?')?'&':'?') + 'probe=' + Date.now();
    }).then(()=>ok++).catch(()=>fail++);
  }
  result.innerHTML = `<span class="ok">Loaded: ${ok}</span> • <span class="bad">Failed: ${fail}</span>. The quiz auto‑falls back even if some sources fail.`;
}

document.getElementById('selfTestBtn').addEventListener('click', selfTest);
</script>
</body>
</html>
